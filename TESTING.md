# Руководство по тестированию Traffic HUD

## Подготовка тестового видео

### Вариант 1: Использовать готовое видео

Поместите видеофайл с дорожным движением в `backend/test_video.mp4`:

```bash
# Пример: скопируйте существующее видео
cp /path/to/your/traffic_video.mp4 backend/test_video.mp4
```

### Вариант 2: Скачать с YouTube

Используйте скрипт (требуется yt-dlp):

```bash
cd backend
./download_test_video.sh
```

Или вручную:

```bash
cd backend
yt-dlp -f "best[ext=mp4]" "YOUTUBE_URL" -o test_video.mp4
```

### Вариант 3: Использовать YouTube Live

В `.env` установите:

```env
VIDEO_SOURCE_TYPE=youtube_url
YOUTUBE_URL=https://www.youtube.com/watch?v=H0Z6faxNLCI
```

## Настройка .env

1. Откройте `backend/.env`:

```bash
cd backend
nano .env  # или используйте любой редактор
```

2. Настройте параметры:

```env
# Для локального файла
VIDEO_SOURCE_TYPE=file
VIDEO_SOURCE_FILE=./test_video.mp4

# FPS обработки (рекомендуется 10 для CPU)
FPS=10

# Порог уверенности детекции (0.0-1.0, чем выше - тем строже)
CONFIDENCE_THRESHOLD=0.25

# TTL событий в часах
EVENT_TTL_HOURS=24
```

## Калибровка ROI

1. **Запустите систему** (см. ниже)
2. **Откройте видео** в видеоплеере с координатами мыши
3. **Определите координаты**:
   - Области дороги (ROI)
   - Линии подсчета
   - Полос движения
4. **Отредактируйте** `backend/roi_config.json`
5. **Перезапустите** систему

Подробнее: см. [CALIBRATION.md](./CALIBRATION.md)

## Запуск тестирования

### Через Docker (рекомендуется)

```bash
# Из корневой директории проекта
docker compose up --build

# В другом терминале проверьте логи
docker compose logs -f backend
```

### Локально (для разработки)

#### Backend:

```bash
cd backend
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt

# Убедитесь, что .env настроен
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

#### Frontend:

```bash
cd frontend
npm install
npm run dev
```

## Проверка работы

1. **Откройте браузер**: http://localhost:3000
2. **Проверьте статус**: Должен быть "STREAM: LIVE"
3. **Наблюдайте события**: Должны появляться в левой/правой панелях
4. **Проверьте статистику**: "Last 60 min" должен обновляться
5. **Откройте детали**: Кликните на событие для просмотра деталей

## Проверка API

```bash
# Статистика
curl http://localhost:8000/api/stats

# События
curl http://localhost:8000/api/events?side=left&limit=10

# Детали события
curl http://localhost:8000/api/events/1
```

## Отладка

### Проблема: Нет детекций

1. Проверьте логи backend:
   ```bash
   docker compose logs backend
   ```

2. Убедитесь, что:
   - Видео загружается (проверьте путь в .env)
   - ROI настроен правильно
   - CONFIDENCE_THRESHOLD не слишком высокий

3. Попробуйте снизить порог:
   ```env
   CONFIDENCE_THRESHOLD=0.15
   ```

### Проблема: Неправильный подсчет

1. Проверьте `roi_config.json`:
   - Координаты соответствуют разрешению видео
   - Counting line находится на пути движения
   - Направление правильное (toward_camera/away_from_camera)

2. Визуализируйте ROI (можно добавить отладочный режим)

### Проблема: Видео не загружается

1. Проверьте путь к файлу:
   ```bash
   ls -la backend/test_video.mp4
   ```

2. Для YouTube: убедитесь, что URL доступен

3. Проверьте формат: поддерживаются mp4, avi, mov, mkv

## Тестовые сценарии

### 1. Базовый тест

- ✅ Система запускается
- ✅ Видео загружается
- ✅ Детекции работают
- ✅ События создаются
- ✅ UI обновляется

### 2. Тест подсчета

- ✅ События создаются при пересечении линии
- ✅ Правильная сторона (left/right)
- ✅ Правильная полоса (1/2/3)
- ✅ Статистика обновляется

### 3. Тест snapshots

- ✅ Snapshots создаются для left side
- ✅ Номера размыты
- ✅ Snapshots отображаются в UI
- ✅ Modal открывается с деталями

### 4. Тест real-time

- ✅ WebSocket подключение
- ✅ События приходят в реальном времени
- ✅ Fallback на polling при отключении WS

## Производительность

Ожидаемые показатели на CPU:

- **FPS обработки**: 5-12 FPS (зависит от CPU)
- **Задержка детекции**: 100-300ms на кадр
- **Память**: ~500MB-1GB (зависит от модели YOLO)

Для улучшения производительности:

- Используйте GPU (CUDA) для YOLOv8
- Уменьшите FPS в .env
- Используйте меньшую модель YOLO (yolov8n.pt уже самый маленький)

## Следующие шаги после тестирования

1. ✅ Калибровка ROI под ваше видео
2. ✅ Настройка FPS и порогов
3. ✅ Тестирование на реальном потоке
4. ✅ Мониторинг производительности
5. ✅ Настройка очистки данных (TTL)

