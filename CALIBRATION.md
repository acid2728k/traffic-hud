# Инструкция по калибровке ROI

## Что такое ROI?

ROI (Region of Interest) - это области на видео, которые определяют:
- Где находится дорога для каждой стороны (левая/правая)
- Где проходит линия подсчета (когда автомобиль пересекает эту линию, он считается)
- Где находятся полосы движения (1, 2, 3 для каждой стороны)

## Шаг 1: Подготовка

1. Запустите систему с тестовым видеофайлом
2. Откройте видео в любом видеоплеере, который показывает координаты мыши
3. Или используйте инструменты для разметки (LabelImg, CVAT, VGG Image Annotator)

## Шаг 2: Определение координат

### Левая сторона (TOWARD CAMERA)

1. **ROI (область интереса)**:
   - Найдите область, где видны автомобили, движущиеся к камере
   - Определите 4 точки полигона (обычно прямоугольник)
   - Запишите координаты: `[[x1, y1], [x2, y2], [x3, y3], [x4, y4]]`
   - Пример для видео 1920x1080: `[[100, 200], [900, 200], [900, 800], [100, 800]]`

2. **Counting Line (линия подсчета)**:
   - Выберите линию, которую пересекают автомобили
   - Обычно горизонтальная линия в середине ROI
   - Определите начальную и конечную точки: `[x1, y1]` и `[x2, y2]`
   - Пример: `"start": [200, 500], "end": [800, 500]`
   - Направление: `"toward_camera"` (y уменьшается при движении)

3. **Lanes (полосы)**:
   - Разделите ROI на 3 равные части по ширине
   - Для каждой полосы определите 4 точки полигона
   - Пример для полосы 1: `[[100, 200], [366, 200], [366, 800], [100, 800]]`
   - Полоса 2: `[[366, 200], [633, 200], [633, 800], [366, 800]]`
   - Полоса 3: `[[633, 200], [900, 200], [900, 800], [633, 800]]`

### Правая сторона (AWAY FROM CAMERA)

Аналогично левой стороне, но:
- Направление: `"away_from_camera"` (y увеличивается при движении)
- ROI может быть другой области экрана

## Шаг 3: Редактирование roi_config.json

Откройте файл `backend/roi_config.json` и замените координаты:

```json
{
  "left_side": {
    "name": "LEFT SIDE (TOWARD CAMERA)",
    "direction": "toward_camera",
    "roi": {
      "polygon": [[ВАШИ_КООРДИНАТЫ]]
    },
    "counting_line": {
      "start": [ВАША_X1, ВАША_Y1],
      "end": [ВАША_X2, ВАША_Y2],
      "direction": "toward_camera"
    },
    "lanes": [
      {
        "id": 1,
        "polygon": [[КООРДИНАТЫ_ПОЛОСЫ_1]]
      },
      {
        "id": 2,
        "polygon": [[КООРДИНАТЫ_ПОЛОСЫ_2]]
      },
      {
        "id": 3,
        "polygon": [[КООРДИНАТЫ_ПОЛОСЫ_3]]
      }
    ]
  },
  "right_side": {
    // аналогично
  }
}
```

## Шаг 4: Проверка

1. Перезапустите систему
2. Проверьте логи backend - должны быть сообщения о загрузке конфига
3. Наблюдайте за подсчетом в UI
4. Если подсчет неправильный:
   - Проверьте, что counting line находится на пути движения
   - Убедитесь, что направление правильное
   - Проверьте, что ROI охватывает всю дорогу

## Советы

- **Используйте инструменты разметки**: LabelImg, CVAT, VGG Image Annotator помогут точно определить координаты
- **Тестируйте на реальном видео**: Запустите систему и смотрите, правильно ли определяются события
- **Начните с простого**: Сначала настройте одну сторону, затем другую
- **Проверяйте направление**: Убедитесь, что направление движения соответствует настройкам

## Примеры инструментов

- **LabelImg**: https://github.com/tzutalin/labelImg
- **CVAT**: https://github.com/openvinotoolkit/cvat
- **VGG Image Annotator**: https://www.robots.ox.ac.uk/~vgg/software/via/

